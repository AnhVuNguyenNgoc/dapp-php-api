if (typeof web3 !== 'undefined') {
      web3 = new Web3(web3.givenProvider );
    } else {
     web3= new Web3(new Web3.providers.HttpProvider("https://ropsten.infura.io/v3/f7778f45fb3c410bba5124725a804988"))
}

//account của trường 
var account={
	address:'',
	privateKey:'',
	contractABI:[{"constant":true,"inputs":[],"name":"totalDiploma","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"onwer","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_idDiploma","type":"string"},{"name":"_owner","type":"address"}],"name":"verifyDiploma","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"name":"","type":"address"}],"name":"diplomas","outputs":[{"name":"idDiploma","type":"string"},{"name":"graduatedYear","type":"string"},{"name":"ownerName","type":"string"},{"name":"major","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[],"name":"getDiploma","outputs":[{"name":"","type":"string"},{"name":"","type":"string"},{"name":"","type":"string"},{"name":"","type":"string"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"_owner","type":"address"},{"name":"_graduatedYear","type":"string"},{"name":"_ownerName","type":"string"},{"name":"_major","type":"string"},{"name":"_idDiploma","type":"string"}],"name":"setDiploma","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"nameSchool","outputs":[{"name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[],"name":"getSchoolInformation","outputs":[{"name":"","type":"string"},{"name":"","type":"address"},{"name":"","type":"uint256"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"inputs":[],"payable":false,"stateMutability":"nonpayable","type":"constructor"}],
	contractAddress:'',
}

// ==done==
function createAccount(){
	let temp=web3.eth.accounts.create();

	account.address=temp.address;

	//do thằng buffer lát gửi TX nó ko cần 2 kí tự '0x' 
	temp.privateKey=temp.privateKey.substring(2,temp.privateKey.length);
	account.privateKey=temp.privateKey;

	return account;
}

//tốn 1h ko chịu suy nghĩ, phân tích trc nè, quên chưa lấy tiền cho account sao deploy smart contract
//GET API là xong . response về money ln. khỏi cần meta mask

//==have not done yet==
function getEtherAutomatically(){

 	var xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function() {
         if (this.readyState == 4 && this.status == 200) {
             alert(this.responseText);
         }
    };
    xhttp.open("POST", "Your Rest URL Here", true);
    xhttp.setRequestHeader("Content-type", "application/json");
    xhttp.send("Your JSON Data Here");
}

// ==done==
function deploySmartContract(){

  	let privateKey = new EthJS.Buffer.Buffer(account.privateKey,'hex')

 	const dataContract= '0x6060604052341561000f57600080fd5b60408051908101604052600381527f534755000000000000000000000000000000000000000000000000000000000060208201526000908051610056929160200190610077565b5060018054600160a060020a03191633600160a060020a0316179055610112565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f106100b857805160ff19168380011785556100e5565b828001600101855582156100e5579182015b828111156100e55782518255916020019190600101906100ca565b506100f19291506100f5565b5090565b61010f91905b808211156100f157600081556001016100fb565b90565b610f28806101216000396000f30060606040526004361061008d5763ffffffff7c010000000000000000000000000000000000000000000000000000000060003504166329db036981146100925780633433edd9146100b757806340a1cd3e146100e6578063529f615f146101565780639004fae3146103285780639a8262561461033b5780639b87b28214610462578063e3978af5146104ec575b600080fd5b341561009d57600080fd5b6100a561058e565b60405190815260200160405180910390f35b34156100c257600080fd5b6100ca610594565b604051600160a060020a03909116815260200160405180910390f35b34156100f157600080fd5b61014260046024813581810190830135806020601f8201819004810201604051908101604052818152929190602084018383808284375094965050509235600160a060020a031692506105a3915050565b604051901515815260200160405180910390f35b341561016157600080fd5b610175600160a060020a03600435166106ae565b6040518080602001806020018060200180602001858103855289818151815260200191508051906020019080838360005b838110156101be5780820151838201526020016101a6565b50505050905090810190601f1680156101eb5780820380516001836020036101000a031916815260200191505b50858103845288818151815260200191508051906020019080838360005b83811015610221578082015183820152602001610209565b50505050905090810190601f16801561024e5780820380516001836020036101000a031916815260200191505b50858103835287818151815260200191508051906020019080838360005b8381101561028457808201518382015260200161026c565b50505050905090810190601f1680156102b15780820380516001836020036101000a031916815260200191505b50858103825286818151815260200191508051906020019080838360005b838110156102e75780820151838201526020016102cf565b50505050905090810190601f1680156103145780820380516001836020036101000a031916815260200191505b509850505050505050505060405180910390f35b341561033357600080fd5b61017561093e565b341561034657600080fd5b61046060048035600160a060020a03169060446024803590810190830135806020601f8201819004810201604051908101604052818152929190602084018383808284378201915050505050509190803590602001908201803590602001908080601f01602080910402602001604051908101604052818152929190602084018383808284378201915050505050509190803590602001908201803590602001908080601f01602080910402602001604051908101604052818152929190602084018383808284378201915050505050509190803590602001908201803590602001908080601f016020809104026020016040519081016040528181529291906020840183838082843750949650610c0795505050505050565b005b341561046d57600080fd5b610475610ce4565b60405160208082528190810183818151815260200191508051906020019080838360005b838110156104b1578082015183820152602001610499565b50505050905090810190601f1680156104de5780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b34156104f757600080fd5b6104ff610d82565b604051600160a060020a03831660208201526040810182905260608082528190810185818151815260200191508051906020019080838360005b83811015610551578082015183820152602001610539565b50505050905090810190601f16801561057e5780820380516001836020036101000a031916815260200191505b5094505050505060405180910390f35b60025481565b600154600160a060020a031681565b6000805b6002548110156106a757600160a060020a03831660009081526003602052604090819020905180828054600181600116156101000203166002900480156106255780601f10610603576101008083540402835291820191610625565b820191906000526020600020905b815481529060010190602001808311610611575b5050915050604051908190039020846040518082805190602001908083835b602083106106635780518252601f199092019160209182019101610644565b6001836020036101000a0380198251168184511617909252505050919091019250604091505051908190039020141561069f57600191506106a7565b6001016105a7565b5092915050565b6003602052806000526040600020600091509050806000018054600181600116156101000203166002900480601f01602080910402602001604051908101604052809291908181526020018280546001816001161561010002031660029004801561075a5780601f1061072f5761010080835404028352916020019161075a565b820191906000526020600020905b81548152906001019060200180831161073d57829003601f168201915b505050505090806001018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156107f85780601f106107cd576101008083540402835291602001916107f8565b820191906000526020600020905b8154815290600101906020018083116107db57829003601f168201915b505050505090806002018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156108965780601f1061086b57610100808354040283529160200191610896565b820191906000526020600020905b81548152906001019060200180831161087957829003601f168201915b505050505090806003018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156109345780601f1061090957610100808354040283529160200191610934565b820191906000526020600020905b81548152906001019060200180831161091757829003601f168201915b5050505050905084565b610946610e4f565b61094e610e4f565b610956610e4f565b61095e610e4f565b33600160a060020a031660009081526003602081815260409283902080549093600180860194600280880195918801948894938116156101000260001901160491601f8301829004820290910190519081016040528092919081815260200182805460018160011615610100020316600290048015610a1e5780601f106109f357610100808354040283529160200191610a1e565b820191906000526020600020905b815481529060010190602001808311610a0157829003601f168201915b50505050509350828054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610aba5780601f10610a8f57610100808354040283529160200191610aba565b820191906000526020600020905b815481529060010190602001808311610a9d57829003601f168201915b50505050509250818054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610b565780601f10610b2b57610100808354040283529160200191610b56565b820191906000526020600020905b815481529060010190602001808311610b3957829003601f168201915b50505050509150808054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610bf25780601f10610bc757610100808354040283529160200191610bf2565b820191906000526020600020905b815481529060010190602001808311610bd557829003601f168201915b50505050509050935093509350935090919293565b60015433600160a060020a03908116911614610c2257600080fd5b600160a060020a0385166000908152600360205260409020818051610c4b929160200190610e61565b50600160a060020a0385166000908152600360205260409020600101848051610c78929160200190610e61565b50600160a060020a0385166000908152600360205260409020600201838051610ca5929160200190610e61565b50600160a060020a038516600090815260036020819052604090912001828051610cd3929160200190610e61565b505060028054600101905550505050565b60008054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610d7a5780601f10610d4f57610100808354040283529160200191610d7a565b820191906000526020600020905b815481529060010190602001808311610d5d57829003601f168201915b505050505081565b610d8a610e4f565b6000806000600160009054906101000a9004600160a060020a0316600254828054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610e3d5780601f10610e1257610100808354040283529160200191610e3d565b820191906000526020600020905b815481529060010190602001808311610e2057829003601f168201915b50505050509250925092509250909192565b60206040519081016040526000815290565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f10610ea257805160ff1916838001178555610ecf565b82800160010185558215610ecf579182015b82811115610ecf578251825591602001919060010190610eb4565b50610edb929150610edf565b5090565b610ef991905b80821115610edb5760008155600101610ee5565b905600a165627a7a7230582038272f9a1495c45c6cf8857c39477005f557c606b0944ff30c6e9a9fb4c1455b0029'

	web3.eth.getTransactionCount(account.address,(err,txNonce)=>{

		var txObject={
			nonce: web3.utils.toHex(txNonce),
			gasLimit:web3.utils.toHex(4700000),
			gasPrice:web3.utils.toHex(web3.utils.toWei('10','gwei')),
			data:dataContract
		}
		//Step 2: signed tx
		var tx=new EthJS.Tx(txObject);
		tx.sign(privateKey);

		const serializedTx=tx.serialize();
		const rawTransaction="0x"+serializedTx.toString('hex');

		//Step 3: sendRawTransaction
		web3.eth.sendSignedTransaction(rawTransaction,(err,result)=>{
			if(!err)
				{
					//đưa tx hash chưa chắc là thành công nha
					console.log('transaction hash: ',result);
				}
			console.log(err)
		})
	})
}

// send tx to insert students

// -----------đang tĩnh send tx thêm thui nhé
// -----------chưa kết hợp lại thành luồng. từ đăng ký xog ---> có account r----> thêm bằng mới vào

// ==done==
function sendTxToSmartContract(){

  	let privateKey = new EthJS.Buffer.Buffer('2d307110bab412689f8efa3a22466fac5aafc0e299449c685f6750450b26101f','hex')


	let contractABI=[{"constant":true,"inputs":[],"name":"totalDiploma","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"onwer","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_idDiploma","type":"string"},{"name":"_owner","type":"address"}],"name":"verifyDiploma","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"name":"","type":"address"}],"name":"diplomas","outputs":[{"name":"idDiploma","type":"string"},{"name":"graduatedYear","type":"string"},{"name":"ownerName","type":"string"},{"name":"major","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[],"name":"getDiploma","outputs":[{"name":"","type":"string"},{"name":"","type":"string"},{"name":"","type":"string"},{"name":"","type":"string"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"_owner","type":"address"},{"name":"_graduatedYear","type":"string"},{"name":"_ownerName","type":"string"},{"name":"_major","type":"string"},{"name":"_idDiploma","type":"string"}],"name":"setDiploma","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"nameSchool","outputs":[{"name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[],"name":"getSchoolInformation","outputs":[{"name":"","type":"string"},{"name":"","type":"address"},{"name":"","type":"uint256"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"inputs":[],"payable":false,"stateMutability":"nonpayable","type":"constructor"}]
	let contractAddress='0x7abcc69a496a7885a6fCFE58bC8b2020B4dc2C11'

	let contract = new web3.eth.Contract(contractABI,contractAddress);

	web3.eth.getTransactionCount('0xC93A00de4B875fEDa0D44Ba11EC8337269A6b4Ea',(err,txNonce)=>{
		
		let dataContract=contract.methods.setDiploma('0x100FE5a6e5409F650E0D495453955f22c01e493b',"2018","anh vũ","it","hash1").encodeABI();		   
		
		var txObject={
			nonce: web3.utils.toHex(txNonce),
			gasLimit:web3.utils.toHex(4600000),
			gasPrice:web3.utils.toHex(web3.utils.toWei('10','gwei')),

			to:contractAddress,
			data:dataContract
		}

		//Step 2: signed tx
		var tx=new EthJS.Tx(txObject);
		tx.sign(privateKey);

		const serializedTx=tx.serialize();
		const rawTransaction="0x"+serializedTx.toString('hex');

		//Step 3: sendRawTransaction
		web3.eth.sendSignedTransaction(rawTransaction,(err,result)=>{
			if(!err)
				{
					//thành công r sao nè
						console.log('transaction hash: ',result);
						0x0e52413c25bbb934bd1fe6646230dea2f13c6174ea0426c4596059f22e7d0005  
					// qr code tạo cho thằng này ở đây 
				}
			console.log(err)
		})

	})

}

//==have not done yet==
function init(){

	createAccount(function(account){

		deploySmartContract(account);

	});
	//gọi create xong then deploy
	// update code bằng cái mà return cái hàm ln khỏi then
}